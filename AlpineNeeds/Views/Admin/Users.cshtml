@model PaginatedList<AlpineNeeds.Controllers.UserViewModel>
@{
    ViewData["Title"] = "Управление на потребители";
}

<div class="container mt-4">
    <h1>Управление на потребители</h1>
    <p>Управлявайте всички потребители в системата</p>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">
            @TempData["Success"]
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">
            @TempData["Error"]
        </div>
    }

    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th>
                                <a asp-action="Users" 
                                   asp-route-sortColumn="username"
                                   asp-route-sortOrder="@(Model.SortColumn == "username" && Model.SortOrder == SortOrder.Ascending ? "desc" : "asc")"
                                   asp-route-pageNumber="@Model.PageIndex"
                                   class="text-dark text-decoration-none">
                                    Потребителско име
                                    @if (Model.SortColumn == "username")
                                    {
                                        @if (Model.SortOrder == SortOrder.Ascending)
                                        {
                                            <i class="bi bi-arrow-up"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-arrow-down"></i>
                                        }
                                    }
                                    else
                                    {
                                        <i class="bi bi-arrow-down-up"></i>
                                    }
                                </a>
                            </th>
                            <th>
                                <a asp-action="Users" 
                                   asp-route-sortColumn="email"
                                   asp-route-sortOrder="@(Model.SortColumn == "email" && Model.SortOrder == SortOrder.Ascending ? "desc" : "asc")"
                                   asp-route-pageNumber="@Model.PageIndex"
                                   class="text-dark text-decoration-none">
                                    Имейл
                                    @if (Model.SortColumn == "email")
                                    {
                                        @if (Model.SortOrder == SortOrder.Ascending)
                                        {
                                            <i class="bi bi-arrow-up"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-arrow-down"></i>
                                        }
                                    }
                                    else
                                    {
                                        <i class="bi bi-arrow-down-up"></i>
                                    }
                                </a>
                            </th>
                            <th>Роли</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model.Items)
                        {
                            <tr>
                                <td>@user.UserName</td>
                                <td>@user.Email</td>
                                <td>@string.Join(", ", user.Roles)</td>
                                <td>
                                    @if (user.IsLockedOut)
                                    {
                                        <span class="badge bg-danger">Заключен</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Активен</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <form asp-action="ToggleAdminRole" method="post">
                                            <input type="hidden" name="id" value="@user.Id" />
                                            @if (user.IsAdmin)
                                            {
                                                <button type="submit" class="btn btn-sm btn-warning me-1" title="Премахване на администраторска роля">
                                                    <i class="bi bi-shield-x"></i> Премахване на администратор
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="submit" class="btn btn-sm btn-primary me-1" title="Назначаване на администратор">
                                                    <i class="bi bi-shield-plus"></i> Назначаване на администратор
                                                </button>
                                            }
                                        </form>

                                        <form asp-action="ToggleUserLockout" method="post">
                                            <input type="hidden" name="id" value="@user.Id" />
                                            @if (user.IsLockedOut)
                                            {
                                                <button type="submit" class="btn btn-sm btn-success me-1" title="Отключване на потребител">
                                                    <i class="bi bi-unlock"></i> Отключване
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="submit" class="btn btn-sm btn-danger me-1" title="Заключване на потребител">
                                                    <i class="bi би-lock"></i> Заключване
                                                </button>
                                            }
                                        </form>

                                        <form asp-action="DeleteUser" method="post" 
                                              onsubmit="return confirm('Сигурни ли сте, че искате да изтриете този потребител?');">
                                            <input type="hidden" name="id" value="@user.Id" />
                                            <button type="submit" class="btn btn-sm btn-danger" title="Изтриване на потребител">
                                                <i class="bi bi-trash"></i> Изтриване
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <nav aria-label="Навигация на страници" class="mt-3">
                    <ul class="pagination justify-content-center">
                        @if (Model.HasPreviousPage)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-action="Users" 
                                   asp-route-pageNumber="@(Model.PageIndex - 1)"
                                   asp-route-sortColumn="@Model.SortColumn"
                                   asp-route-sortOrder="@Model.SortOrder.ToString().ToLower()">Предишна</a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item disabled">
                                <span class="page-link">Предишна</span>
                            </li>
                        }

                        @for (var i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                                <a class="page-link" asp-action="Users" 
                                   asp-route-pageNumber="@i"
                                   asp-route-sortColumn="@Model.SortColumn"
                                   asp-route-sortOrder="@Model.SortOrder.ToString().ToLower()">@i</a>
                            </li>
                        }

                        @if (Model.HasNextPage)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-action="Users" 
                                   asp-route-pageNumber="@(Model.PageIndex + 1)"
                                   asp-route-sortColumn="@Model.SortColumn"
                                   asp-route-sortOrder="@Model.SortOrder.ToString().ToLower()">Следваща</a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item disabled">
                                <span class="page-link">Следваща</span>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function() {
            // Автоматично скриване на известия след 3 секунди
            window.setTimeout(function() {
                $(".alert").fadeTo(500, 0).slideUp(500, function() {
                    $(this).remove();
                });
            }, 3000);
        });
    </script>
}